{% extends "base.html" %}

{% block title %}Account Settings • Mood Journal{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-8">
  <a href="/home" class="text-sm text-gray-600 hover:text-gray-900">← Back to Home</a>

  <div class="mt-6 bg-white rounded-xl shadow p-6">
    <h2 class="text-2xl font-bold mb-2">Account Settings</h2>
    <p class="text-gray-600 mb-6">Manage your account — update your profile, change your password, or delete your account.</p>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-6 space-y-2">
          {% for category, message in messages %}
            <div class="p-4 rounded-lg {% if category == 'error' %}bg-red-100 border border-red-400 text-red-700{% else %}bg-green-100 border border-green-400 text-green-700{% endif %}">
              <div class="flex items-start gap-2">
                {% if category == 'error' %}
                  <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                  </svg>
                {% else %}
                  <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                  </svg>
                {% endif %}
                <span>{{ message }}</span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Link to registration for creating a new account -->
    <div class="mb-6">
      <p class="text-sm text-gray-700">Need to create a new account? <a href="{{ url_for('register') }}" class="text-amber-600 font-semibold">Register here</a>.</p>
    </div>

    <!-- Profile Information Section -->
    <div class="mb-8">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-gray-800">Profile Information</h3>
        <button 
          type="button" 
          id="editProfileBtn" 
          onclick="toggleEditMode()" 
          class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg hover:from-amber-600 hover:to-orange-600 transition-all duration-200 font-semibold shadow-md hover:shadow-lg"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
          Edit
        </button>
      </div>

      <!-- View Mode (Read-only) -->
      <div id="profileViewMode" class="space-y-4">
        <div class="bg-gray-50 rounded-lg p-4">
          <label class="block text-sm font-medium text-gray-500 mb-1">Username</label>
          <p class="text-gray-900 text-lg font-medium">{{ user.username }}</p>
        </div>
        <div class="bg-gray-50 rounded-lg p-4">
          <label class="block text-sm font-medium text-gray-500 mb-1">Email</label>
          <p class="text-gray-900 text-lg font-medium">{{ user.email }}</p>
        </div>
      </div>

      <!-- Edit Mode (Form) -->
      <form method="POST" class="space-y-4 hidden" id="updateProfileForm" onsubmit="return validateProfileUpdate()">
        <input type="hidden" name="action" value="update_profile">
        
        <!-- Username error -->
        <div id="usernameError" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg flex items-start gap-2">
          <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <div>
            <strong>Username error!</strong>
            <p class="text-sm" id="usernameErrorText">Please check your username.</p>
          </div>
        </div>
        
        <!-- Email error -->
        <div id="emailError" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg flex items-start gap-2">
          <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <div>
            <strong>Email error!</strong>
            <p class="text-sm" id="emailErrorText">Please check your email address.</p>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
          <input 
            id="username" 
            name="username" 
            type="text" 
            value="{{ user.username }}" 
            required 
            class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" 
            oninput="validateUsername()"
            minlength="3"
            maxlength="100"
          />
          <p class="text-xs text-gray-500 mt-1">Username must be at least 3 characters long</p>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <input 
            id="email" 
            name="email" 
            type="email" 
            value="{{ user.email }}" 
            required 
            class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500" 
            oninput="validateEmail()"
          />
        </div>
        
        <div class="flex gap-3">
          <button type="submit" class="bg-gradient-to-r from-amber-500 to-orange-500 text-white px-6 py-2 rounded-lg hover:from-amber-600 hover:to-orange-600 transition-all duration-200 font-semibold shadow-md hover:shadow-lg">
            Save Changes
          </button>
          <button 
            type="button" 
            onclick="toggleEditMode()" 
            class="bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 transition-all duration-200 font-semibold"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>

    <hr class="my-6">

    <!-- Change password form -->
    <form method="POST" class="space-y-4" id="changePasswordForm" onsubmit="return validatePasswordChange()">
      <input type="hidden" name="action" value="change_password">
      
      <!-- Current password error -->
      <div id="currentPasswordError" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg flex items-start gap-2">
        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <div>
          <strong>Incorrect current password!</strong>
          <p class="text-sm">The current password you entered is wrong.</p>
        </div>
      </div>
      
      <!-- New password mismatch error -->
      <div id="passwordMismatchError" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg flex items-start gap-2">
        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <div>
          <strong>New passwords don't match!</strong>
          <p class="text-sm">Your new password and confirmation must be identical.</p>
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700">Current password</label>
        <input id="currentPassword" name="current_password" type="password" required class="mt-1 w-full px-3 py-2 border rounded" oninput="checkCurrentPassword()" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">New password</label>
        <input id="newPassword" name="new_password" type="password" required class="mt-1 w-full px-3 py-2 border rounded" oninput="checkPasswordMatch()" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Confirm new password</label>
        <input id="confirmPassword" name="confirm_password" type="password" required class="mt-1 w-full px-3 py-2 border rounded" oninput="checkPasswordMatch()" />
      </div>
      <div>
        <button type="submit" class="bg-amber-500 text-white px-4 py-2 rounded hover:bg-amber-600">Change password</button>
      </div>
    </form>

    <hr class="my-6">

    <!-- Delete account form -->
    <form method="POST" onsubmit="return confirmDeleteAccount()">
      <input type="hidden" name="action" value="delete_account">
      <p class="text-sm text-gray-700 mb-3">Deleting your account will remove all your entries and cannot be undone.</p>
      <div>
        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded">Delete account</button>
      </div>
    </form>
  </div>
</div>

<script>
let isEditMode = false;

function toggleEditMode() {
  isEditMode = !isEditMode;
  const viewMode = document.getElementById('profileViewMode');
  const editMode = document.getElementById('updateProfileForm');
  const editBtn = document.getElementById('editProfileBtn');
  
  if (isEditMode) {
    viewMode.classList.add('hidden');
    editMode.classList.remove('hidden');
    editBtn.classList.add('hidden');
    // Focus on username field when entering edit mode
    document.getElementById('username').focus();
  } else {
    viewMode.classList.remove('hidden');
    editMode.classList.add('hidden');
    editBtn.classList.remove('hidden');
    // Reset form values to original
    document.getElementById('username').value = '{{ user.username }}';
    document.getElementById('email').value = '{{ user.email }}';
    // Clear any error messages
    document.getElementById('usernameError').classList.add('hidden');
    document.getElementById('emailError').classList.add('hidden');
  }
}

function validateUsername() {
  const username = document.getElementById('username').value.trim();
  const errorDiv = document.getElementById('usernameError');
  const errorText = document.getElementById('usernameErrorText');
  
  if (!username) {
    errorDiv.classList.add('hidden');
    return;
  }
  
  if (username.length < 3) {
    errorText.textContent = 'Username must be at least 3 characters long.';
    errorDiv.classList.remove('hidden');
    return;
  }
  
  // Clear error if valid
  errorDiv.classList.add('hidden');
}

function validateEmail() {
  const email = document.getElementById('email').value.trim();
  const errorDiv = document.getElementById('emailError');
  const errorText = document.getElementById('emailErrorText');
  
  if (!email) {
    errorDiv.classList.add('hidden');
    return;
  }
  
  // Basic email validation
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    errorText.textContent = 'Please enter a valid email address.';
    errorDiv.classList.remove('hidden');
    return;
  }
  
  // Clear error if valid
  errorDiv.classList.add('hidden');
}

function validateProfileUpdate() {
  const username = document.getElementById('username').value.trim();
  const email = document.getElementById('email').value.trim();
  
  // Validate username
  if (!username || username.length < 3) {
    validateUsername();
    document.getElementById('username').focus();
    return false;
  }
  
  // Validate email
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!email || !emailRegex.test(email)) {
    validateEmail();
    document.getElementById('email').focus();
    return false;
  }
  
  // Check if anything changed
  const originalUsername = '{{ user.username }}';
  const originalEmail = '{{ user.email }}';
  
  if (username === originalUsername && email === originalEmail) {
    alert('No changes detected. Please update at least one field.');
    return false;
  }
  
  return confirm('Update your profile information?');
}

function checkCurrentPassword() {
  const currentPassword = document.getElementById('currentPassword').value;
  const errorMessage = document.getElementById('currentPasswordError');
  
  if (!currentPassword) {
    errorMessage.classList.add('hidden');
    return;
  }
  
  // Send to backend to validate
  fetch('/check-password', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: currentPassword })
  })
  .then(response => response.json())
  .then(data => {
    if (data.correct) {
      errorMessage.classList.add('hidden');
    } else {
      errorMessage.classList.remove('hidden');
    }
  })
  .catch(error => console.log('Error checking password:', error));
}

function checkPasswordMatch() {
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const errorMessage = document.getElementById('passwordMismatchError');
  
  if (newPassword && confirmPassword && newPassword !== confirmPassword) {
    errorMessage.classList.remove('hidden');
  } else {
    errorMessage.classList.add('hidden');
  }
}

function validatePasswordChange() {
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  if (newPassword !== confirmPassword) {
    document.getElementById('passwordMismatchError').classList.remove('hidden');
    return false;
  }
  
  return confirm('Change your password now?');
}

function confirmDeleteAccount() {
  return confirm('Are you sure you want to permanently delete your account? This cannot be undone.');
}
</script>

{% endblock %}
