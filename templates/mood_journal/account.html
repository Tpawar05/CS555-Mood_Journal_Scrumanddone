{% extends "base.html" %}

{% block title %}Account Settings • Mood Journal{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto py-8">
  <a href="/home" class="text-sm text-gray-600 hover:text-gray-900">← Back to Home</a>

  <div class="mt-6 bg-white rounded-xl shadow p-6">
    <h2 class="text-2xl font-bold mb-2">Account Settings</h2>
    <p class="text-gray-600 mb-6">Manage your account — change your password or delete your account.</p>

    <!-- Link to registration for creating a new account -->
    <div class="mb-6">
      <p class="text-sm text-gray-700">Need to create a new account? <a href="{{ url_for('register') }}" class="text-amber-600 font-semibold">Register here</a>.</p>
    </div>

    <!-- Change password form -->
    <form method="POST" class="space-y-4" id="changePasswordForm" onsubmit="return validatePasswordChange()">
      <input type="hidden" name="action" value="change_password">
      
      <!-- Current password error -->
      <div id="currentPasswordError" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg flex items-start gap-2">
        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <div>
          <strong>Incorrect current password!</strong>
          <p class="text-sm">The current password you entered is wrong.</p>
        </div>
      </div>
      
      <!-- New password mismatch error -->
      <div id="passwordMismatchError" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg flex items-start gap-2">
        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <div>
          <strong>New passwords don't match!</strong>
          <p class="text-sm">Your new password and confirmation must be identical.</p>
        </div>
      </div>
      
      <div>
        <label class="block text-sm font-medium text-gray-700">Current password</label>
        <input id="currentPassword" name="current_password" type="password" required class="mt-1 w-full px-3 py-2 border rounded" oninput="checkCurrentPassword()" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">New password</label>
        <input id="newPassword" name="new_password" type="password" required class="mt-1 w-full px-3 py-2 border rounded" oninput="checkPasswordMatch()" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Confirm new password</label>
        <input id="confirmPassword" name="confirm_password" type="password" required class="mt-1 w-full px-3 py-2 border rounded" oninput="checkPasswordMatch()" />
      </div>
      <div>
        <button type="submit" class="bg-amber-500 text-white px-4 py-2 rounded hover:bg-amber-600">Change password</button>
      </div>
    </form>

    <hr class="my-6">

    <!-- Delete account form -->
    <form method="POST" onsubmit="return confirmDeleteAccount()">
      <input type="hidden" name="action" value="delete_account">
      <p class="text-sm text-gray-700 mb-3">Deleting your account will remove all your entries and cannot be undone.</p>
      <div>
        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded">Delete account</button>
      </div>
    </form>
  </div>
</div>

<script>
function checkCurrentPassword() {
  const currentPassword = document.getElementById('currentPassword').value;
  const errorMessage = document.getElementById('currentPasswordError');
  
  if (!currentPassword) {
    errorMessage.classList.add('hidden');
    return;
  }
  
  // Send to backend to validate
  fetch('/check-password', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: currentPassword })
  })
  .then(response => response.json())
  .then(data => {
    if (data.correct) {
      errorMessage.classList.add('hidden');
    } else {
      errorMessage.classList.remove('hidden');
    }
  })
  .catch(error => console.log('Error checking password:', error));
}

function checkPasswordMatch() {
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const errorMessage = document.getElementById('passwordMismatchError');
  
  if (newPassword && confirmPassword && newPassword !== confirmPassword) {
    errorMessage.classList.remove('hidden');
  } else {
    errorMessage.classList.add('hidden');
  }
}

function validatePasswordChange() {
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  if (newPassword !== confirmPassword) {
    document.getElementById('passwordMismatchError').classList.remove('hidden');
    return false;
  }
  
  return confirm('Change your password now?');
}

function confirmDeleteAccount() {
  return confirm('Are you sure you want to permanently delete your account? This cannot be undone.');
}
</script>

{% endblock %}
