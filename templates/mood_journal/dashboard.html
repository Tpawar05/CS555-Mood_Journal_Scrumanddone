{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  /* Fade out non-selected moods */
  .faded {
    opacity: 0.25;
  }

  /* Small colored dot */
  .mood-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-left: 4px;
  }

  .dot-terrible { background-color: #ef4444; }
  .dot-bad { background-color: #f97316; }
  .dot-neutral { background-color: #eab308; }
  .dot-good { background-color: #22c55e; }
  .dot-excellent { background-color: #3b82f6; }

  .emoji-hidden { visibility: hidden; }

  .mood-marker {
    position: absolute;
    bottom: 0.5rem;
    right: 0.5rem;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <div class="p-4">
    <h1 class="text-2xl font-bold mb-4">Mood Dashboard - {{ current_month }}</h1>

    <!-- TOP 4 METRICS (updated from 3 to 4 columns) -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="p-4 bg-white rounded shadow">
        <div class="text-sm text-gray-500">Average Mood</div>
        <div class="text-3xl font-semibold">{{ average_mood|round(1) }}</div>
        <div class="mt-2 text-2xl">
          {% set avg_bucket = (average_mood|round(0))|int %}
          {% if avg_bucket <= 1 %}üò≠{% elif avg_bucket == 2 %}‚òπÔ∏è{% elif avg_bucket == 3 %}üòê{% elif avg_bucket == 4 %}üôÇ{% else %}üòÑ{% endif %}
        </div>
      </div>

      <div class="p-4 bg-white rounded shadow">
        <div class="text-sm text-gray-500">Total Entries</div>
        <div class="text-3xl font-semibold">{{ total_entries }}</div>
      </div>

      <div class="p-4 bg-white rounded shadow">
        <div class="text-sm text-gray-500">Mood Distribution</div>
        <canvas id="moodDistChart" height="80"></canvas>
      </div>

      <!-- ‚≠ê NEW CARD: STREAK + BADGES -->
      <div class="p-4 bg-white rounded shadow">
        <div class="text-sm text-gray-500">Your Streak</div>
        <div class="text-3xl font-semibold">{{ current_streak }} days</div>

        {% if badges %}
        <div class="mt-3">
          <h4 class="text-sm font-medium text-gray-600 mb-1">Badges</h4>
          <div class="flex flex-wrap gap-2">
            {% for b in badges %}
            <span class="px-3 py-1 rounded-full bg-purple-100 text-purple-700 text-xs font-medium">
              {{ b }}
            </span>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- MONTHLY CALENDAR BLOCK -->
    <div class="bg-white rounded shadow p-4 mb-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-xl">{{ current_month }}</h2>
      </div>

      <!-- FILTER PILLS -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button class="px-3 py-1 rounded-full text-sm border bg-red-100 text-red-700"
                onclick="applyFilter('terrible')">üò≠ Terrible (1‚Äì2)</button>

        <button class="px-3 py-1 rounded-full text-sm border bg-orange-100 text-orange-700"
                onclick="applyFilter('bad')">üòü Bad (3‚Äì4)</button>

        <button class="px-3 py-1 rounded-full text-sm border bg-yellow-100 text-yellow-700"
                onclick="applyFilter('neutral')">üòê Neutral (5‚Äì6)</button>

        <button class="px-3 py-1 rounded-full text-sm border bg-green-100 text-green-700"
                onclick="applyFilter('good')">üôÇ Good (7‚Äì8)</button>

        <button class="px-3 py-1 rounded-full text-sm border bg-blue-100 text-blue-700"
                onclick="applyFilter('excellent')">üòÑ Excellent (9‚Äì10)</button>

        <button class="px-3 py-1 rounded-full text-sm border bg-gray-100 text-gray-700"
                onclick="applyFilter('')">Clear</button>
      </div>

      <!-- MONTHLY SUMMARY LINE -->
      {% if summary_days > 0 %}
      <div class="text-sm text-gray-600 mb-4">
        {{ summary_days }} {{ "day" if summary_days == 1 else "days" }}
        {{ "was" if summary_days == 1 else "were" }}
        {{ summary_label }} ‚Äî {{ summary_message }}
      </div>
      {% endif %}

      <!-- MONTH SWITCH -->
      <div class="mb-3">
        <a href="?month={{ month-1 }}&filter={{ request.args.get('filter','') }}">‚óÄ</a>
        <a href="?month={{ month+1 }}&filter={{ request.args.get('filter','') }}">‚ñ∂</a>
      </div>

      <!-- CALENDAR TABLE -->
      <table class="w-full border-collapse">
        <thead>
          <tr class="text-sm text-gray-600">
            <th class="p-2">Sun</th>
            <th class="p-2">Mon</th>
            <th class="p-2">Tue</th>
            <th class="p-2">Wed</th>
            <th class="p-2">Thu</th>
            <th class="p-2">Fri</th>
            <th class="p-2">Sat</th>
          </tr>
        </thead>
        <tbody>
          {% set selected_filter = request.args.get('filter') %}
          {% for week in calendar_dates %}
          <tr>
            {% for day, mood, bucket in week %}
            {% if day %}
              <td class="border p-2 h-28 align-top relative">

                <div class="text-xs text-gray-500">{{ day.day }}</div>

                {% if bucket %}
                  {% set hide_emoji = selected_filter and bucket != selected_filter %}
                  {% set fade_dot = selected_filter and bucket != selected_filter %}

                  <div class="mood-marker">
                    <span class="{% if hide_emoji %}emoji-hidden{% endif %}">
                      {% if mood %}
                        {% if mood <= 2 %}üò≠
                        {% elif mood <= 4 %}üòü
                        {% elif mood <= 6 %}üòê
                        {% elif mood <= 8 %}üôÇ
                        {% else %}üòÑ
                        {% endif %}
                      {% endif %}
                    </span>

                    <span class="mood-dot dot-{{ bucket }} {% if fade_dot %}faded{% endif %}"></span>
                  </div>
                {% endif %}
              </td>
            {% else %}
              <td class="border p-2 h-28 bg-gray-50"></td>
            {% endif %}
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- CHARTS BELOW (unchanged) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="p-4 bg-white rounded shadow">
        <h3 class="font-semibold mb-2">Weekly Trend (Mon‚ÜíSun)</h3>
        <canvas id="weeklyTrendChart" height="100"></canvas>
      </div>

      <div class="p-4 bg-white rounded shadow">
        <h3 class="font-semibold mb-2">Last 7 Days</h3>
        <canvas id="last7Chart" height="100"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
function applyFilter(bucket) {
    const params = new URLSearchParams(window.location.search);
    if (bucket) params.set("filter", bucket);
    else params.delete("filter");
    window.location.search = params.toString();
}
</script>

<script>
  const moodDist = {{ mood_distribution | tojson }};
  const weekly = {{ weekly_trend | tojson }};
  const last7 = {{ last7_trend | tojson }};

  new Chart(document.getElementById('moodDistChart'), {
    type: 'doughnut',
    data: {
      labels: ["Terrible","Bad","Neutral","Good","Excellent"],
      datasets: [{
        data: moodDist,
        backgroundColor: ["#ef4444","#f97316","#eab308","#22c55e","#3b82f6"]
      }]
    },
    options: { plugins: { legend: { position:'bottom' } }}
  });

  new Chart(document.getElementById('weeklyTrendChart'), {
    type: 'line',
    data: {
      labels: ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],
      datasets: [{
        data: weekly,
        borderColor:"#8b5cf6",
        tension:0.4,
        spanGaps:true
      }]
    },
    options:{ scales:{ y:{ min:0,max:10 }}, plugins:{legend:{display:false}}}
  });

  new Chart(document.getElementById('last7Chart'), {
    type:'line',
    data:{
      labels:["-6","-5","-4","-3","-2","-1","0"],
      datasets:[{
        data:last7,
        borderColor:"#3b82f6",
        tension:0.35,
        spanGaps:true
      }]
    },
    options:{ scales:{y:{min:0,max:10}}, plugins:{legend:{display:false}}}
  });
</script>

{% endblock %}
