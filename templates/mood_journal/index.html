<!-- language: html -->
{% extends "base.html" %}

{% block title %}Mood Journal ‚Ä¢ Student Starter Pack{% endblock %}

{% block extra_head %}
<style>
    @keyframes float {
        0% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-10px) rotate(5deg); }
        100% { transform: translateY(0px) rotate(0deg); }
    }
    .float-animation {
        animation: float 4s ease-in-out infinite;
    }
    .timer-badge {
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        font-weight: 600;
        background: #fff7ed;
        color: #92400e;
        padding: .4rem .7rem;
        border-radius: .75rem;
        border: 1px solid #fcd34d;
        box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
</style>
{% endblock %}

{% block content %}
<div class="mb-8">
    <a href="/home" class="inline-flex items-center text-sm text-gray-600 hover:text-gray-900 mb-6">
        ‚Üê Back to Home
    </a>
    
    
    <div class="flex items-center gap-4 mb-4">
        <div class="p-3 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-xl text-white float-animation">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
        </div>
        <div>
            <h2 class="text-3xl font-bold text-gray-900">Mood Journal</h2>
            <p class="text-gray-600">Your emotional landscape, beautifully tracked</p>
        </div>

        <!-- Timer display -->
        <div class="ml-auto">
            <div id="page-timer" class="timer-badge" aria-live="polite">
                ‚è±Ô∏è <span id="elapsed-display">00:00</span>
            </div>
        </div>
    </div>
</div>

<div class="bg-gradient-to-r from-amber-50 via-orange-50 to-yellow-50 rounded-xl p-6 mb-8 border border-amber-200">
    <div class="flex items-start gap-3">
        <span class="text-2xl">üåà</span>
        <div>
            <h3 class="font-semibold text-gray-900 mb-1">Dreamy Reflections</h3>
            <p class="text-gray-600 text-sm">
                A soft, calming space for emotional awareness and self-reflection.
                Track your moods with a gentle, supportive interface that celebrates all feelings.
            </p>
        </div>
    </div>
</div>

<!-- Left: Mood Input Form (Only this section kept) -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
    <div class="flex items-center gap-2 mb-6">
        <span class="text-xl">‚ú®</span>
        <h3 class="text-lg font-semibold text-gray-900">Add a New Entry</h3>
    </div>

    <form method="POST" action="/mood-journal" class="space-y-6" id="mood-form" enctype="multipart/form-data">
        <!-- Hidden input to send elapsed seconds -->
        <input type="hidden" name="time_spent_seconds" id="time_spent_seconds" value="0">

        <!-- Mood Label -->
        <div>
            <label for="mood_label" class="block text-sm font-medium text-gray-700 mb-2">Mood Label</label>
            <input id="mood_label" name="title" type="text" required
            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-200"
            placeholder="e.g., Calm, Excited, Anxious">

        </div>

        <!-- Date -->
        <div>
            <label for="entry_date" class="block text-sm font-medium text-gray-700 mb-2">Date</label>
            <input id="entry_date" name="date" type="date"
                   class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-200"
                   value="{{ current_date }}">
        </div>

        <!-- Mood Rating -->
        <div>
            <label for="mood_rating" class="block text-sm font-medium text-gray-700 mb-2">
                üí´ Mood Rating (1‚Äì10)
            </label>
            <input
                    type="range"
                    id="mood_rating"
                    name="mood_rating"
                    min="1"
                    max="10"
                    value="5"
                    oninput="updateMoodLabel(this.value)"
                    class="w-full accent-amber-500 cursor-pointer"
            >
            <p id="rating-label" class="text-center font-semibold text-gray-800 mt-2">5 ‚Äì Neutral üòê</p>
            <p class="text-xs text-gray-500 text-center mt-1">
                Slide to reflect your current mood
            </p>
        </div>

        <!-- Notes -->
        <div>
            <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                Thoughts & Reflections
            </label>
            <textarea id="notes" name="notes" rows="4"

                      class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent transition-all duration-200"
                      placeholder="What's coloring your mood today? What are you grateful for?"></textarea>
        </div>
        <div class="mt-2 flex items-center justify-center gap-2">
            <button type="button" id="voice-btn"
                    class="px-3 py-2 bg-amber-100 text-amber-800 rounded-md border border-amber-200 hover:bg-amber-200 focus:outline-none"
                    aria-pressed="false" aria-label="Start voice typing">
                üéôÔ∏è Start voice typing
            </button>

            <span id="voice-status" class="text-sm text-gray-500" aria-live="polite"></span>
        </div>

        <!-- Image Upload -->
        <div>
            <label for="image" class="block text-sm font-medium text-gray-700 mb-2">
                üì∑ Add Media (Optional)
            </label>
            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-amber-400 transition-colors">
                <div class="space-y-1 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <div class="flex text-sm text-gray-600">
                        <label for="image" class="relative cursor-pointer bg-white rounded-md font-medium text-amber-600 hover:text-amber-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-amber-500">
                            <span>Upload a file</span>
                            <input id="image" name="image" type="file" accept="image/*" class="sr-only" onchange="previewImage(this)">
                        </label>
                        <p class="pl-1">or drag and drop</p>
                    </div>
                    <p class="text-xs text-gray-500">PNG, JPG, GIF, WEBP up to 16MB</p>
                </div>
            </div>
            <div id="image-preview" class="mt-4 hidden">
                <img id="preview-img" src="" alt="Preview" class="max-w-full h-auto rounded-lg border border-gray-200 max-h-64 mx-auto">
                <button type="button" onclick="removeImage()" class="mt-2 text-sm text-red-600 hover:text-red-800">Remove image</button>
            </div>
        </div>

        <!-- Submit -->
        <button type="submit" id="save-button"
                class="w-full bg-gradient-to-r from-amber-500 to-orange-500 text-white py-3 rounded-lg font-medium hover:from-amber-600 hover:to-orange-600 transform hover:scale-[1.02] transition-all duration-200 shadow-lg">
            üíú Save This Moment
        </button>
    </form>

    <script>
        // --- Dynamic Mood Label + Emoji ---
        function updateMoodLabel(value) {
            const label = document.getElementById("rating-label");
            const val = parseInt(value);
            let moodText = "";
            let emoji = "";

            if (val <= 2) {
                moodText = "Terrible";
                emoji = "üòû";
            } else if (val <= 4) {
                moodText = "Bad";
                emoji = "üòï";
            } else if (val === 5) {
                moodText = "Neutral";
                emoji = "üòê";
            } else if (val <= 7) {
                moodText = "Good";
                emoji = "üôÇ";
            } else if (val <= 9) {
                moodText = "Great";
                emoji = "üòÑ";
            } else {
                moodText = "Amazing";
                emoji = "ü§©";
            }

            label.textContent = `${val} ‚Äì ${moodText} ${emoji}`;
        }

        // --- Timer Functionality ---
        (function() {
            const start = Date.now();
            let timerInterval = null;
            const display = document.getElementById("elapsed-display");
            const hiddenInput = document.getElementById("time_spent_seconds");
            const form = document.getElementById("mood-form");
            const saveBtn = document.getElementById("save-button");

            function pad(n) { return n < 10 ? "0" + n : n; }

            function update() {
                const seconds = Math.floor((Date.now() - start) / 1000);
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                display.textContent = pad(mins) + ":" + pad(secs);
            }

            document.addEventListener("DOMContentLoaded", function() {
                update();
                timerInterval = setInterval(update, 1000);
            });

            form.addEventListener("submit", async function(e) {
                e.preventDefault();

                // Stop timer and set hidden input
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                const elapsedSeconds = Math.floor((Date.now() - start) / 1000);
                hiddenInput.value = String(elapsedSeconds);
                display.textContent = (function(){
                    const m = Math.floor(elapsedSeconds / 60);
                    const s = elapsedSeconds % 60;
                    return pad(m) + ":" + pad(s);
                })();

                // Disable save button while saving
                saveBtn.disabled = true;
                const originalHtml = saveBtn.innerHTML;
                saveBtn.textContent = "Saving...";

                try {
                    const formData = new FormData(form);
                    const method = (form.method || "POST").toUpperCase();
                    const resp = await fetch(form.action, {
                        method: method,
                        body: formData,
                        headers: { "X-Requested-With": "XMLHttpRequest" }
                    });

                    if (resp.ok) {
                        window.location.href = "/home";
                    } else {
                        const text = await resp.text();
                        alert("Save failed: " + (text || resp.status));
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalHtml;
                    }
                } catch (err) {
                    alert("Network error: " + err.message);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalHtml;
                }
            });
        })();

        // Image preview functionality
        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeImage() {
            const input = document.getElementById('image');
            const preview = document.getElementById('image-preview');
            input.value = '';
            preview.classList.add('hidden');
        }
    </script>
    <!-- html -->
    <script>
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            console.log('SpeechRecognition supported');
        } else {
            console.error('Speech recognition not supported in this browser.');
        }
        (function() {
            const voiceBtn = document.getElementById('voice-btn');
            const statusEl = document.getElementById('voice-status');
            const notes = document.getElementById('notes');
            const form = document.getElementById('mood-form');

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                if (voiceBtn) {
                    voiceBtn.disabled = true;
                    statusEl.textContent = 'Voice typing not supported in this browser.';
                    voiceBtn.title = 'Not supported';
                }
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.lang = (document.documentElement.lang || 'en-US');
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            let isListening = false;
            let lastInterim = ''; // stores the previously-inserted interim text

            function updateButton() {
                voiceBtn.textContent = isListening ? '‚èπÔ∏è Stop' : 'üéôÔ∏è Start voice typing';
                voiceBtn.setAttribute('aria-pressed', String(isListening));
                statusEl.textContent = isListening ? 'Listening‚Ä¶' : '';
            }

            recognition.addEventListener('start', () => {
                console.log('SpeechRecognition: started');
                statusEl.textContent = 'Listening‚Ä¶';
            });

            recognition.addEventListener('result', (ev) => {
                let finalTranscript = '';
                let interimBuffer = '';

                for (let i = ev.resultIndex; i < ev.results.length; ++i) {
                    const res = ev.results[i];
                    if (res.isFinal) {
                        finalTranscript += res[0].transcript;
                    } else {
                        interimBuffer += res[0].transcript;
                    }
                }


                // Remove previously added interim from textarea if present
                if (lastInterim && notes.value.endsWith(lastInterim)) {
                    notes.value = notes.value.slice(0, -lastInterim.length);
                    lastInterim = '';
                }

                // Append final transcript permanently
                if (finalTranscript) {
                    const cur = notes.value;
                    notes.value = cur + (cur && !cur.endsWith(' ') ? ' ' : '') + finalTranscript;
                }

                // Append current interim as temporary text and remember it
                if (interimBuffer) {
                    const cur = notes.value;
                    notes.value = cur + (cur && !cur.endsWith(' ') ? ' ' : '') + interimBuffer;
                    lastInterim = interimBuffer;

                } else {
                    lastInterim = '';
                }

                // keep caret at end so typing appears natural
                try {
                    const end = notes.value.length;
                    notes.selectionStart = notes.selectionEnd = end;
                    notes.scrollTop = notes.scrollHeight;
                } catch (e) {
                    // ignore if textarea not focusable
                }

                // Update accessible status
                statusEl.textContent = isListening ? ('Listening‚Ä¶ ' + (interimBuffer || '')) : (interimBuffer || '');
            });

            recognition.addEventListener('end', () => {
                if (isListening) {
                    // some browsers stop automatically; restart if still intended
                    try { recognition.start(); } catch (e) { isListening = false; updateButton(); }
                } else {
                    updateButton();
                }
            });

            recognition.addEventListener('error', (ev) => {
                console.error('SpeechRecognition: error', ev.error || ev);
                statusEl.textContent = 'Voice error: ' + (ev.error || 'unknown');
                isListening = false;
                updateButton();
            });

            voiceBtn.addEventListener('click', () => {
                if (!isListening) {
                    try {
                        recognition.start();
                        isListening = true;
                        console.log('Voice button: start requested');
                    } catch (err) {
                        statusEl.textContent = 'Could not start: ' + err.message;
                        console.error('Voice start error:', err);
                        isListening = false;
                    }
                } else {
                    isListening = false;
                    recognition.stop();
                }
                updateButton();
            });

            // Stop recognition when the form is submitted
            form.addEventListener('submit', () => {
                if (isListening) {
                    isListening = false;
                    recognition.stop();
                    updateButton();
                }
            });

            // accessibility: allow Ctrl+M to toggle
            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'm') {
                    e.preventDefault();
                    voiceBtn.click();
                }
            });

            updateButton();
        })();
    </script>






</div>


<div class="mt-8 bg-gradient-to-r from-amber-500 to-orange-600 rounded-xl p-8 text-white">
    <div class="max-w-3xl mx-auto text-center">
        <h3 class="text-2xl font-bold mb-2">Mindfulness Tip</h3>
        <p class="opacity-90">
            Taking just 5 minutes each day to check in with your emotions can improve self-awareness and emotional regulation by up to 40%.
        </p>
    </div>
</div>
{% endblock %}
